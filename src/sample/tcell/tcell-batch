#!/bin/sh
PORT_NUM=8888
if [ "x$LISP" = 'x' ]; then
    LISP=alisp
fi

while getopts o:e: opt
do
    case ${opt} in
        l)
            LISP=${OPTARG};;
        c)
            WORKER_CMD=${OPTARG};;
        n)
            NNODE=${OPTARG};;
        i)
            INITIAL_TASK=${OPTARG};;
        h) 
            HOSTNAME=${OPTARG};;
        p)
            PORT_NUM=${OPTARG};;
        *)
            echo "usage: $0 -c <worker_command> -n <n_node> -i <initial_task> -h <hostname> [-p <port_num=9999>] [-l <lisp(alisp|sbcl)>"
            exit 1;;
    esac
done


SERVER_CMDLINE="server-cmdline.lsp"

if [ "x$WORKER_CMD" = 'x' ]; then
    echo "WORKER_CMD not specified"
    exit 1
fi
if [ "x$NNODE" = 'x' ]; then
    echo "NNODE not specified"
    exit 1
fi
if [ "x$INITIAL_TASK" = 'x' ]; then
    echo "INITIAL_TASK not specified"
    exit 1
fi
if [ "x$HOSTNAME" = 'x' ]; then
    echo "HOSTNAME not specified"
    exit 1
fi

if [ $LISP = 'alisp' ]; then
    "$LISP" -batch -L $SERVER_CMDLINE -- -h $HOSTNAME -p $PORT_NUM -n $NNODE -t "$INITIAL_TASK" &
elif [ $LISP = 'sbcl' ]; then
    "$LISP" --script $SERVER_CMDLINE -h $HOSTNAME -p $PORT_NUM -n $NNODE -t "$INITIAL_TASK" &
else
    echo "Unknown Lisp Implementation: $LISP"
    exit 1
fi
sleep 5

i=1
while [ $i -lt $NNODE ]; do
    ./tcpcon $HOSTNAME $PORT_NUM $WORKER_CMD &
    sleep 1
    i=`expr $i + 1`
done
# ./tcpcon $HOSTNAME $PORT_NUM $WORKER_CMD
$WORKER_CMD -s $HOSTNAME -p $PORT_NUM